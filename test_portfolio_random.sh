#!/bin/bash

# 랜덤 종목 10개로 포트폴리오 분석 테스트

# 제공된 데이터에서 종목 정보 파싱
# 형식: 종목코드,종목명 ... 시가총액,PER,PBR,ROE,부채비율,배당수익률

DATA="028260,삼성물산,384147.0,18.4,1.25,6.62,57.62,2600.0
028670,팬오션,20474.0,7.63,0.36,7.1,93.15,12.0
029460,케이씨,3453.0,7.61,0.45,8.62,19.99,64.0
029530,신도리코,4289.0,5.86,0.39,-0.29,6.1,30.0
029780,삼성카드,57408.0,8.64,0.65,7.89,263.15,56.0
030000,제일기획,23411.0,11.28,1.34,11.12,124.44,615.0
030190,NICE평가정보,8623.0,11.44,2.05,19.66,34.41,92.0
030200,KT,123869.0,26.57,0.75,14.73,123.52,12.0
030210,다올투자증권,2202.0,-5.2,0.42,9.84,1150.28,3.0
030610,교보증권,10747.0,9.13,0.54,10.4,760.56,10.0
030720,동원수산,294.0,5.75,0.6,18.16,118.07,0.0
031210,서울보증보험,35260.0,16.55,0.68,3.27,81.31,114.6
031430,신세계인터내셔날,3633.0,11.3,0.43,1.09,60.57,40.0
031440,신세계푸드,1367.0,12.21,0.47,12.99,145.1,18.0
031820,아이티센씨티에스,671.0,3.6,0.37,0.06,170.1,0.0
032350,롯데관광개발,14428.0,-11.86,4.36,-10.79,554.6,0.0
032560,황금에스티,959.0,5.87,0.26,5.6,24.82,30.0
032640,LG유플러스,65506.0,17.76,0.77,8.87,115.96,5.0
032830,삼성생명,308600.0,14.65,0.94,8.94,848.14,900.0
033180,KH 필룩스,1382.0,-2.75,0.28,4.47,122.45,0.0
033240,자화전자,4721.0,28.93,1.17,-5.62,72.05,0.0
033250,체시스,350.0,5.75,0.9,18.23,102.02,0.0
033270,유나이티드제약,3105.0,9.56,0.72,8.27,16.67,90.0
033530,SJG세종,2292.0,6.79,0.49,19.0,166.15,30.0
033780,KT&G,160869.0,14.95,1.64,8.66,52.01,28.0
033920,무학,2451.0,5.06,0.41,10.5,21.42,65.0
034020,두산에너빌리티,568178.0,509.77,7.58,1.65,126.22,0.0
034120,SBS,3708.0,10.96,0.41,-0.27,81.13,0.0
034220,LG디스플레이,73500.0,-2.73,1.12,18.52,268.3,0.0
034230,파라다이스,17086.0,22.47,1.02,6.29,82.53,30.0
034310,NICE,5150.0,10.94,0.65,6.76,161.91,100.0
034590,인천도시가스,1148.0,5.96,0.5,8.85,103.01,25.0"

echo "=== 랜덤 종목 10개 포트폴리오 분석 테스트 ==="
echo ""

# 랜덤으로 10개 선택
SELECTED=$(echo "$DATA" | shuf -n 10)

# JSON 배열 생성
JSON_STOCKS="["
FIRST=true

while IFS=',' read -r code name market_cap per pbr roe debt_ratio dividend_yield; do
    # 투자금액 랜덤 생성 (10만원 ~ 1000만원)
    investment_amount=$(python3 -c "import random; print(random.randint(100000, 10000000))")
    
    # 시가총액을 억원 단위로 변환 (원본이 억원인지 확인 필요, 여기서는 그대로 사용)
    # market_cap이 이미 적절한 단위라고 가정
    
    if [ "$FIRST" = true ]; then
        FIRST=false
    else
        JSON_STOCKS+=","
    fi
    
    JSON_STOCKS+="
    {
      \"단축코드\": \"$code\",
      \"한글명\": \"$name\",
      \"시가총액\": $market_cap,
      \"per\": $per,
      \"pbr\": $pbr,
      \"ROE\": $roe,
      \"부채비율\": $debt_ratio,
      \"배당수익률\": $dividend_yield,
      \"투자금액\": $investment_amount
    }"
done <<< "$SELECTED"

JSON_STOCKS+="
  ]"

# 전체 JSON 요청 생성
REQUEST_JSON="{
  \"stocks\": $JSON_STOCKS
}"

echo "선택된 종목:"
echo "$SELECTED" | awk -F',' '{print "  - " $1 " (" $2 ")"}'
echo ""
echo "요청 전송 중..."
echo ""

# API 호출
RESPONSE=$(curl -s -X POST http://localhost:8000/portfolio/analyze \
  -H "Content-Type: application/json" \
  -d "$REQUEST_JSON")

# 응답 포맷팅 및 출력
echo "=== 응답 결과 ==="
echo "$RESPONSE" | python3 -m json.tool 2>/dev/null || echo "$RESPONSE"

echo ""
echo "=== 테스트 완료 ==="

