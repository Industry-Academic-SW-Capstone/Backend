<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í˜¸ê°€ì°½ WebSocket í…ŒìŠ¤íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background-color: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; }
        button { padding: 10px 20px; margin: 5px; font-size: 14px; cursor: pointer; border: none; border-radius: 4px; }
        .connected { background-color: #4CAF50; color: white; }
        .disconnected { background-color: #f44336; color: white; }
        .status { padding: 8px 16px; border-radius: 4px; display: inline-block; margin-left: 10px; }

        .orderbook-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .orderbook-panel {
            flex: 1;
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .orderbook-header {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }

        .orderbook-table {
            width: 100%;
            border-collapse: collapse;
        }

        .orderbook-table th {
            background-color: #f8f9fa;
            padding: 10px;
            text-align: center;
            font-size: 12px;
            color: #666;
            border-bottom: 1px solid #ddd;
        }

        .orderbook-table td {
            padding: 8px;
            text-align: right;
            font-size: 13px;
        }

        .ask-row {
            background-color: #ffebee;
        }

        .ask-row:hover {
            background-color: #ffcdd2;
        }

        .bid-row {
            background-color: #e3f2fd;
        }

        .bid-row:hover {
            background-color: #bbdefb;
        }

        .price-ask {
            color: #d32f2f;
            font-weight: bold;
        }

        .price-bid {
            color: #1976d2;
            font-weight: bold;
        }

        .summary-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }

        .summary-label {
            font-weight: bold;
            color: #666;
        }

        .summary-value {
            color: #333;
        }

        .expected-price {
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
            background-color: #f8f9fa;
        }

        .expected-price.up {
            color: #d32f2f;
            background-color: #ffebee;
        }

        .expected-price.down {
            color: #1976d2;
            background-color: #e3f2fd;
        }

        .expected-price.steady {
            color: #666;
        }

        #messages {
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: scroll;
            background-color: white;
            border-radius: 4px;
            margin-top: 20px;
        }

        .message {
            padding: 6px;
            margin: 3px 0;
            font-size: 12px;
            color: #666;
        }

        .stock-selector {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .stock-selector h3 {
            margin-top: 0;
        }

        .stock-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .stock-button {
            background-color: #2196F3;
            color: white;
        }

        .stock-button:hover {
            background-color: #1976D2;
        }

        .stock-button.unsubscribe {
            background-color: #FF9800;
        }

        .stock-button.unsubscribe:hover {
            background-color: #F57C00;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“Š í˜¸ê°€ì°½ WebSocket ì‹¤ì‹œê°„ í…ŒìŠ¤íŠ¸</h1>

    <div class="stock-selector">
        <h3>ì—°ê²° ìƒíƒœ</h3>
        <button id="connectBtn" onclick="connect()">ì—°ê²°</button>
        <button id="disconnectBtn" onclick="disconnect()" disabled>ì—°ê²° í•´ì œ</button>
        <span id="status" class="status disconnected">ì—°ê²° ì•ˆ ë¨</span>
    </div>

    <div class="stock-selector">
        <h3>ì¢…ëª© êµ¬ë…</h3>
        <div class="stock-buttons">
            <button class="stock-button" onclick="subscribe('005930')">ì‚¼ì„±ì „ì</button>
            <button class="stock-button" onclick="subscribe('000660')">SKí•˜ì´ë‹‰ìŠ¤</button>
            <button class="stock-button" onclick="subscribe('035420')">NAVER</button>
            <button class="stock-button" onclick="subscribe('035720')">ì¹´ì¹´ì˜¤</button>
            <button class="stock-button" onclick="subscribe('005380')">í˜„ëŒ€ì°¨</button>
            <button class="stock-button unsubscribe" onclick="unsubscribeCurrent()">í˜„ì¬ êµ¬ë… í•´ì œ</button>
        </div>
    </div>

    <div id="orderbook-display"></div>

    <div id="messages"></div>
</div>

<script>
    let stompClient = null;
    let currentSubscription = null;
    let currentStockCode = null;
    let orderBookData = null;

    function connect() {
        const socket = new SockJS('http://localhost:8080/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('ì—°ê²°ë¨: ' + frame);
            document.getElementById('status').textContent = 'ì—°ê²°ë¨';
            document.getElementById('status').className = 'status connected';
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;

            addMessage('ì‹œìŠ¤í…œ', 'ì›¹ì†Œì¼“ ì—°ê²° ì„±ê³µ!', '#4CAF50');
        }, function(error) {
            console.error('ì—°ê²° ì‹¤íŒ¨:', error);
            addMessage('ì‹œìŠ¤í…œ', 'ì—°ê²° ì‹¤íŒ¨: ' + error, '#f44336');
        });
    }

    function disconnect() {
        if (currentSubscription) {
            currentSubscription.unsubscribe();
            currentSubscription = null;
        }

        if (stompClient !== null) {
            stompClient.disconnect();
        }

        currentStockCode = null;
        orderBookData = null;
        document.getElementById('orderbook-display').innerHTML = '';

        document.getElementById('status').textContent = 'ì—°ê²° ì•ˆ ë¨';
        document.getElementById('status').className = 'status disconnected';
        document.getElementById('connectBtn').disabled = false;
        document.getElementById('disconnectBtn').disabled = true;
        addMessage('ì‹œìŠ¤í…œ', 'ì›¹ì†Œì¼“ ì—°ê²° í•´ì œ', '#f44336');
    }

    function subscribe(stockCode) {
        if (stompClient === null || !stompClient.connected) {
            alert('ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”!');
            return;
        }

        // ê¸°ì¡´ êµ¬ë… í•´ì œ
        if (currentSubscription) {
            currentSubscription.unsubscribe();
        }

        currentStockCode = stockCode;
        const destination = '/topic/stock/' + stockCode + '/orderbook';

        currentSubscription = stompClient.subscribe(destination, function (message) {
            const data = JSON.parse(message.body);
            orderBookData = data;
            displayOrderBook(data);
        });

        addMessage('ì‹œìŠ¤í…œ', stockCode + ' í˜¸ê°€ì°½ êµ¬ë… ì‹œì‘', '#2196F3');
    }

    function unsubscribeCurrent() {
        if (currentSubscription) {
            currentSubscription.unsubscribe();
            currentSubscription = null;
            currentStockCode = null;
            orderBookData = null;
            document.getElementById('orderbook-display').innerHTML = '';
            addMessage('ì‹œìŠ¤í…œ', 'í˜¸ê°€ì°½ êµ¬ë… í•´ì œ', '#FF9800');
        }
    }

    function displayOrderBook(data) {
        const container = document.getElementById('orderbook-display');

        // ì˜ˆìƒ ì²´ê²°ê°€
        const expectedPriceClass =
            data.expected_change_sign === '2' || data.expected_change_sign === '1' ? 'up' :
            data.expected_change_sign === '5' || data.expected_change_sign === '4' ? 'down' :
            'steady';

        const expectedChangeSymbol =
            data.expected_change_sign === '2' || data.expected_change_sign === '1' ? 'â–²' :
            data.expected_change_sign === '5' || data.expected_change_sign === '4' ? 'â–¼' :
            '-';

        const html = `
            <div class="orderbook-container">
                <div class="orderbook-panel">
                    <div class="orderbook-header">ë§¤ë„í˜¸ê°€ (ASK)</div>
                    <table class="orderbook-table">
                        <thead>
                            <tr>
                                <th>í˜¸ê°€</th>
                                <th>ì”ëŸ‰</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.ask_levels && data.ask_levels.length > 0
                                ? data.ask_levels.map((level, idx) => `
                                    <tr class="ask-row">
                                        <td class="price-ask">${level.price ? level.price.toLocaleString() : '-'}</td>
                                        <td>${level.quantity ? level.quantity.toLocaleString() : '-'}</td>
                                    </tr>
                                `).join('')
                                : '<tr><td colspan="2" style="text-align: center; color: #999;">í˜¸ê°€ ë°ì´í„° ì—†ìŒ</td></tr>'
                            }
                        </tbody>
                    </table>
                    <div style="margin-top: 10px; padding: 10px; background-color: #ffebee; border-radius: 4px;">
                        <strong>ì´ ë§¤ë„í˜¸ê°€ ì”ëŸ‰:</strong> ${(data.total_ask_quantity || 0).toLocaleString()}
                    </div>
                </div>

                <div class="orderbook-panel">
                    <div class="orderbook-header">ì˜ˆìƒ ì²´ê²°ê°€</div>
                    <div class="expected-price ${expectedPriceClass}">
                        ${data.expected_price ? data.expected_price.toLocaleString() + 'ì›' : '-'}
                        ${data.expected_change_amount ? `<br><small>${expectedChangeSymbol} ${Math.abs(data.expected_change_amount).toLocaleString()}ì› (${data.expected_change_rate || '0.00'}%)</small>` : ''}
                    </div>
                    <div style="margin-top: 15px; font-size: 12px; color: #666;">
                        <div>ì˜ˆìƒ ì²´ê²°ëŸ‰: ${(data.expected_quantity || 0).toLocaleString()}</div>
                        <div>ì˜ˆìƒ ê±°ë˜ëŸ‰: ${(data.expected_volume || 0).toLocaleString()}</div>
                    </div>
                </div>

                <div class="orderbook-panel">
                    <div class="orderbook-header">ë§¤ìˆ˜í˜¸ê°€ (BID)</div>
                    <table class="orderbook-table">
                        <thead>
                            <tr>
                                <th>ì”ëŸ‰</th>
                                <th>í˜¸ê°€</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.bid_levels && data.bid_levels.length > 0
                                ? data.bid_levels.map((level, idx) => `
                                    <tr class="bid-row">
                                        <td>${level.quantity ? level.quantity.toLocaleString() : '-'}</td>
                                        <td class="price-bid">${level.price ? level.price.toLocaleString() : '-'}</td>
                                    </tr>
                                `).join('')
                                : '<tr><td colspan="2" style="text-align: center; color: #999;">í˜¸ê°€ ë°ì´í„° ì—†ìŒ</td></tr>'
                            }
                        </tbody>
                    </table>
                    <div style="margin-top: 10px; padding: 10px; background-color: #e3f2fd; border-radius: 4px;">
                        <strong>ì´ ë§¤ìˆ˜í˜¸ê°€ ì”ëŸ‰:</strong> ${(data.total_bid_quantity || 0).toLocaleString()}
                    </div>
                </div>
            </div>

            <div class="summary-panel">
                <h3 style="margin-top: 0;">ì¢…ëª© ì •ë³´: ${currentStockCode || '-'}</h3>
                <div class="summary-row">
                    <span class="summary-label">ëˆ„ì  ê±°ë˜ëŸ‰:</span>
                    <span class="summary-value">${(data.accumulated_volume || 0).toLocaleString()}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">ì‹œê°„ì™¸ ì´ ë§¤ë„í˜¸ê°€ ì”ëŸ‰:</span>
                    <span class="summary-value">${(data.overtime_total_ask_quantity || 0).toLocaleString()}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">ì‹œê°„ì™¸ ì´ ë§¤ìˆ˜í˜¸ê°€ ì”ëŸ‰:</span>
                    <span class="summary-value">${(data.overtime_total_bid_quantity || 0).toLocaleString()}</span>
                </div>
                <div class="summary-row">
                    <span class="summary-label">ì—…ë°ì´íŠ¸ ì‹œê°„:</span>
                    <span class="summary-value">${data.timestamp || new Date().toLocaleString()}</span>
                </div>
            </div>
        `;

        container.innerHTML = html;
    }

    function addMessage(type, content, color) {
        const messagesDiv = document.getElementById('messages');
        const messageElement = document.createElement('div');
        messageElement.className = 'message';
        messageElement.style.color = color || '#666';
        messageElement.innerHTML = `<strong>[${type}]</strong> ${content} <span style="color: #999; font-size: 11px;">(${new Date().toLocaleTimeString()})</span>`;
        messagesDiv.appendChild(messageElement);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>