{{- if .Values.ingress.enabled -}}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "stockit-backend-chart.fullname" . }}
  labels:
    {{- include "stockit-backend-chart.labels" . | nindent 4 }}
  {{- $annotations := .Values.ingress.annotations | default (dict) }}
  {{- $managedCertEnabled := and .Values.ingress.managedCertificate.enabled (gt (len (.Values.ingress.managedCertificate.domains | default (list))) 0) }}
  {{- $allowHttpKey := "kubernetes.io/ingress.allow-http" }}
  {{- $managedCertKey := "networking.gke.io/managed-certificates" }}
  {{- if or (gt (len $annotations) 0) (and (not (hasKey $annotations $allowHttpKey)) (ne .Values.ingress.allowHttp nil)) (and $managedCertEnabled (not (hasKey $annotations $managedCertKey))) }}
  annotations:
    {{- range $key, $value := $annotations }}
    {{ $key }}: {{ $value | quote }}
    {{- end }}
    {{- if and (not (hasKey $annotations $allowHttpKey)) (ne .Values.ingress.allowHttp nil) }}
    {{ $allowHttpKey }}: {{ ternary "true" "false" .Values.ingress.allowHttp | quote }}
    {{- end }}
    {{- if and $managedCertEnabled (not (hasKey $annotations $managedCertKey)) }}
    {{ $managedCertKey }}: {{ include "stockit-backend-chart.managedCertificateName" . | quote }}
    {{- end }}
  {{- end }}
spec:
  {{- with .Values.ingress.className }}
  ingressClassName: {{ . }}
  {{- end }}
  {{- if .Values.ingress.tls }}
  tls:
    {{- range .Values.ingress.tls }}
    - hosts:
        {{- range .hosts }}
        - {{ . | quote }}
        {{- end }}
      secretName: {{ .secretName }}
    {{- end }}
  {{- end }}
  rules:
    {{- range .Values.ingress.hosts }}
    - host: {{ .host | quote }}
      http:
        paths:
          {{- range .paths }}
          - path: {{ .path }}
            {{- with .pathType }}
            pathType: {{ . }}
            {{- end }}
            backend:
              service:
                {{- $defaultServiceName := printf "%s-spring-service" (include "stockit-backend-chart.fullname" $) }}
                {{- $serviceName := default $defaultServiceName (and .backend .backend.service .backend.service.name) }}
                name: {{ $serviceName }}
                port:
                  {{- $defaultServicePort := $.Values.backend.service.port }}
                  {{- $servicePort := default $defaultServicePort (and .backend .backend.service .backend.service.port .backend.service.port.number) }}
                  number: {{ $servicePort }}
          {{- end }}
    {{- end }}
{{- end }}
